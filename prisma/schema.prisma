generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  bankConnections BankConnection[]
  accounts      Account[]
  transactions  Transaction[]
  cards         Card[]
  goals         Goal[]
  investments   Investment[]
  categorizationRules CategoryRule[]

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
}

model BankConnection {
  id            String              @id @default(cuid())
  userId        String
  provider      BankProvider        @default(PLUGGY)
  itemId        String              @unique // Pluggy Item ID
  status        ConnectionStatus    @default(ACTIVE)
  error         String?
  consentExpiresAt DateTime?
  lastSyncAt    DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts      Account[]

  @@index([userId])
  @@index([itemId])
  @@map("bank_connections")
}

model Account {
  id            String       @id @default(cuid())
  userId        String
  connectionId  String?      // NULL = conta manual, NOT NULL = Open Finance
  externalAccountId String?  @unique // ID da conta no provedor (Pluggy)
  name          String
  type          AccountType
  institution   String
  balance       Decimal      @db.Decimal(15, 2)
  currency      String       @default("BRL")
  color         String?
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  connection    BankConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  transactions  Transaction[]

  @@index([userId])
  @@index([connectionId])
  @@index([externalAccountId])
  @@map("accounts")
}

enum AccountType {
  CHECKING
  SAVINGS
  INVESTMENT
  CASH
  OTHER
}

model Transaction {
  id            String            @id @default(cuid())
  userId        String
  accountId     String?
  cardId        String?
  externalTransactionId String?   @unique // ID da transação no provedor (Pluggy)
  type          TransactionType
  category      String
  amount        Decimal           @db.Decimal(15, 2)
  description   String
  date          DateTime
  isPending     Boolean           @default(false)
  isRecurring   Boolean           @default(false)
  tags          String[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  account       Account?          @relation(fields: [accountId], references: [id], onDelete: SetNull)
  card          Card?             @relation(fields: [cardId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([accountId])
  @@index([cardId])
  @@index([date])
  @@index([externalTransactionId])
  @@map("transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

model Card {
  id            String       @id @default(cuid())
  userId        String
  name          String
  lastFourDigits String      @db.VarChar(4)
  brand         String
  limit         Decimal      @db.Decimal(15, 2)
  closingDay    Int
  dueDay        Int
  color         String?
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([userId])
  @@map("cards")
}

model Goal {
  id              String       @id @default(cuid())
  userId          String
  name            String
  description     String?
  targetAmount    Decimal      @db.Decimal(15, 2)
  currentAmount   Decimal      @db.Decimal(15, 2) @default(0)
  deadline        DateTime
  category        String
  status          GoalStatus   @default(ACTIVE)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions   GoalContribution[]

  @@index([userId])
  @@index([status])
  @@map("goals")
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED
}

model GoalContribution {
  id            String       @id @default(cuid())
  goalId        String
  amount        Decimal      @db.Decimal(15, 2)
  date          DateTime     @default(now())
  note          String?
  createdAt     DateTime     @default(now())

  goal          Goal         @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@map("goal_contributions")
}

model Investment {
  id            String          @id @default(cuid())
  userId        String
  name          String
  type          InvestmentType
  amount        Decimal         @db.Decimal(15, 2)
  currentValue  Decimal         @db.Decimal(15, 2)
  quantity      Decimal?        @db.Decimal(15, 6)
  institution   String
  ticker        String?
  acquiredAt    DateTime
  maturityDate  DateTime?
  profitability Decimal?        @db.Decimal(8, 4)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("investments")
}

enum InvestmentType {
  STOCKS
  BONDS
  REAL_ESTATE
  FIXED_INCOME
  CRYPTO
  FUNDS
  OTHER
}

model CategoryRule {
  id            String       @id @default(cuid())
  userId        String
  pattern       String
  category      String
  matchCount    Int          @default(0)
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pattern])
  @@index([userId])
  @@map("category_rules")
}

enum BankProvider {
  PLUGGY
  BELVO
  MANUAL
}

enum ConnectionStatus {
  ACTIVE
  UPDATING
  LOGIN_ERROR
  OUTDATED
  DISCONNECTED
}
